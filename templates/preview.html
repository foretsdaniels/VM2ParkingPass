<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview Data - Parking Pass Generator</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-eye text-primary"></i>
                    Preview Data
                </h1>
                <p class="lead">Review and select data for parking pass generation</p>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="row mb-4">
                    <div class="col-12">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' if category == 'info' else 'check-circle' }}"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endwith %}

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-success">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <h3 class="mb-0">{{ valid_rows|length }}</h3>
                        <p class="mb-0">Valid Records</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-danger">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <h3 class="mb-0">{{ errors|length }}</h3>
                        <p class="mb-0">Errors</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info">
                    <div class="card-body text-center">
                        <i class="fas fa-file-pdf fa-2x mb-2"></i>
                        <h3 class="mb-0" id="selectedCount">{{ valid_rows|length }}</h3>
                        <p class="mb-0">Will Generate</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex gap-2 justify-content-between">
                    <div>
                        <a href="{{ url_for('reset_session') }}" class="btn btn-secondary">
                            <i class="fas fa-undo"></i>
                            Start Over
                        </a>
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-primary" id="selectAll">
                            <i class="fas fa-check-square"></i>
                            Select All
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="selectNone">
                            <i class="fas fa-square"></i>
                            Select None
                        </button>
                        <button type="button" class="btn btn-success" id="generateBtn" onclick="generatePDF()">
                            <i class="fas fa-file-pdf"></i>
                            Generate PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Valid Data Table -->
        {% if valid_rows %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table"></i>
                    Valid Records ({{ valid_rows|length }})
                </h5>
            </div>
            <div class="card-body">
                <form id="pdfForm" action="{{ url_for('generate_pdf') }}" method="post">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" class="form-check-input" id="selectAllCheckbox" checked>
                                    </th>
                                    <th>Confirmation #</th>
                                    <th>Arrival Date</th>
                                    <th>Departure Date</th>
                                    <th>Nights</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in valid_rows %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input row-checkbox" 
                                               name="selected_rows" value="{{ loop.index0 }}" checked>
                                    </td>
                                    <td><strong>{{ row.confirmation }}</strong></td>
                                    <td>{{ row.arrival }}</td>
                                    <td>{{ row.departure }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ row.nights }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Errors Table -->
        {% if errors %}
        <div class="card">
            <div class="card-header bg-danger">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle"></i>
                    Records with Errors ({{ errors|length }})
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Row #</th>
                                <th>Confirmation</th>
                                <th>Arrival</th>
                                <th>Departure</th>
                                <th>Errors</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in errors %}
                            <tr>
                                <td>{{ row.index + 1 }}</td>
                                <td>{{ row.confirmation or '-' }}</td>
                                <td>{{ row.arrival or '-' }}</td>
                                <td>{{ row.departure or '-' }}</td>
                                <td>
                                    {% for error in row.errors %}
                                        <span class="badge bg-danger me-1">{{ error }}</span>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if not valid_rows and not errors %}
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h3>No Data Available</h3>
                <p class="text-muted">Please upload and process a file first.</p>
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="fas fa-upload"></i>
                    Upload File
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Selection management
        document.getElementById('selectAll').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            document.getElementById('selectAllCheckbox').checked = true;
            updateSelectedCount();
        });

        document.getElementById('selectNone').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('selectAllCheckbox').checked = false;
            updateSelectedCount();
        });

        document.getElementById('selectAllCheckbox').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateSelectedCount();
        });

        document.querySelectorAll('.row-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedCount();
                updateSelectAllCheckbox();
            });
        });

        function updateSelectedCount() {
            const selected = document.querySelectorAll('.row-checkbox:checked').length;
            document.getElementById('selectedCount').textContent = selected;
            
            const generateBtn = document.getElementById('generateBtn');
            if (selected === 0) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-file-pdf"></i> No Rows Selected';
            } else {
                generateBtn.disabled = false;
                generateBtn.innerHTML = `<i class="fas fa-file-pdf"></i> Generate PDF (${selected} passes)`;
            }
        }

        function updateSelectAllCheckbox() {
            const total = document.querySelectorAll('.row-checkbox').length;
            const checked = document.querySelectorAll('.row-checkbox:checked').length;
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (checked === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checked === total) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        function generatePDF() {
            const selected = document.querySelectorAll('.row-checkbox:checked').length;
            if (selected === 0) {
                alert('Please select at least one row to generate PDF.');
                return;
            }
            
            // Show loading state
            const btn = document.getElementById('generateBtn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            btn.disabled = true;
            
            // Submit the form
            document.getElementById('pdfForm').submit();
            
            // Reset button after a delay (in case of errors)
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }, 5000);
        }

        // Initialize counts on page load
        updateSelectedCount();
        updateSelectAllCheckbox();
    </script>
</body>
</html>
